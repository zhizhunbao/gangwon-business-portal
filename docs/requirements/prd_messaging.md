# PRD: 站内信系统 (Internal Messaging System)

**版本**: v1.0  
**日期**: 2026-01-24  
**状态**: 🔄 开发中 (In Progress)

---

## 1. 业务目标与愿景

### 核心痛点

企业用户需要与管理员进行高效沟通，包括咨询问题、绩效数据反馈、支持请求等。传统的邮件沟通缺乏追踪和管理能力。

### 成功指标

- **响应时间**: 平均首次响应 < 4小时 (工作日)
- **解决率**: 问题解决率 > 90%
- **用户满意度**: 沟通满意度评分 > 4.0/5.0

---

## 2. 用户故事

### US-MSG-001: 发送消息

> **作为** 企业用户,  
> **我想要** 通过站内信系统向管理员发送咨询消息,  
> **以便** 获得官方支持和解答。

### US-MSG-002: 消息通知

> **作为** 企业用户,  
> **我想要** 在首页看到未读消息徽章,  
> **以便** 及时知道有新回复。

### US-MSG-003: 消息历史

> **作为** 企业用户,  
> **我想要** 查看与管理员的完整对话历史,  
> **以便** 追踪问题处理进度。

### US-MSG-004: 管理员回复

> **作为** 系统管理员,  
> **我想要** 在后台统一查看和回复企业消息,  
> **以便** 高效处理多个咨询。

### US-MSG-005: 广播消息

> **作为** 系统管理员,  
> **我想要** 向所有或特定企业群发消息,  
> **以便** 发布重要通知。

### US-MSG-006: 邮件通知

> **作为** 企业用户,  
> **我想要** 收到新消息的邮件通知,  
> **以便** 即使不在线也能收到提醒。

---

## 3. 功能详情

### 3.1 消息发送

**消息组成**:

- 主题 (必填)
- 内容 (富文本编辑器)
- 附件 (最多3个文件，每个最大10MB)
- 优先级 (普通/高/紧急)
- 分类 (支持咨询/绩效咨询/一般问题)

**发送流程**:

1. 选择分类
2. 填写主题和内容
3. 上传附件 (可选)
4. 发送

### 3.2 消息线程

**线程管理**:

- 同一主题的消息归为一个线程
- 支持回复功能 (保持线程上下文)
- 线程状态: 开放/已解决/已关闭

**显示信息**:

- 发送者头像/名称
- 发送时间
- 消息内容
- 附件列表
- 已读/未读状态

### 3.3 通知系统

**应用内通知**:

- 首页未读徽章 🔄 **待实现**
- 消息中心铃铛图标
- 实时更新未读数量

**邮件通知** 🔄 **待实现**:

- 新消息通知
- 回复通知
- 用户可配置开关

**推送通知** (可选):

- 紧急消息推送

### 3.4 管理员功能

**消息仪表盘**:

- 所有对话列表
- 未读数量统计
- 平均响应时间

**对话管理**:

- 按企业、分类、状态、日期筛选
- 标记为: 待处理/处理中/已解决
- 分配给特定管理员

**广播功能**:

- 发送对象: 全部/按条件筛选
- 定时发送
- 消息模板

**快捷回复**:

- 常用回复模板
- 自动回复配置

### 3.5 消息分析

**统计指标**:

- 消息量统计 (日/周/月)
- 响应时间分布
- 分类分布
- 解决率

### 3.6 UI/UX 体验

**对话式界面**:

- 类似即时通讯的气泡布局
- 时间戳显示
- 已读回执

**附件预览**:

- 图片: 缩略图预览
- 文档: 文件图标 + 名称

**微互动**:

- 发送按钮加载动画
- 新消息滑入效果
- 未读徽章跳动

### 3.7 国际化 (i18n)

- 韩语/中文双语
- 时间格式本地化
- 系统消息模板本地化

---

## 4. 验收标准

### 消息发送 (企业端)

- [ ] 可选择消息分类
- [ ] 富文本编辑器功能正常
- [ ] 附件限制3个文件，每个10MB
- [ ] 发送成功显示确认

### 消息线程

- [ ] 同一线程消息正确关联
- [ ] 回复功能正常
- [ ] 已读/未读状态正确显示
- [ ] 时间戳正确显示

### 通知系统

- [ ] 首页未读徽章实时更新 🔄
- [ ] 新消息邮件通知发送 🔄
- [ ] 邮件配置开关生效

### 管理员功能

- [ ] 对话列表筛选功能正常
- [ ] 状态标记功能正常
- [ ] 广播消息功能正常
- [ ] 快捷回复模板可用

### 性能要求

- [ ] 消息列表加载 < 1s
- [ ] 发送消息响应 < 1s
- [ ] 未读数量更新 < 2s

### 边界处理

- [ ] 空对话列表友好提示
- [ ] 网络断开提示重试
- [ ] 大附件上传进度显示

---

## 5. 技术注解

### API 端点

**企业端**:
| 方法 | 端点 | 描述 |
|------|------|------|
| GET | `/api/v1/messages/threads` | 获取消息线程列表 |
| GET | `/api/v1/messages/threads/{id}` | 获取线程详情 |
| POST | `/api/v1/messages/threads` | 创建新线程 |
| POST | `/api/v1/messages/threads/{id}/messages` | 发送消息 |
| PUT | `/api/v1/messages/{id}/read` | 标记已读 |
| GET | `/api/v1/messages/unread-count` | 获取未读数量 |

**管理端**:
| 方法 | 端点 | 描述 |
|------|------|------|
| GET | `/api/v1/admin/messages/threads` | 获取所有线程 |
| POST | `/api/v1/admin/messages/broadcast` | 广播消息 |
| GET | `/api/v1/admin/messages/analytics` | 消息统计 |
| PUT | `/api/v1/admin/messages/threads/{id}/status` | 更新线程状态 |

### 数据模型

**消息线程 (message_threads)**:

- id, subject, category, status
- created_by, assigned_to
- last_message_at, message_count, unread_count

**消息 (messages)**:

- id, thread_id, sender_id, sender_type
- content, priority, status
- created_at, read_at

**附件 (message_attachments)**:

- id, message_id, file_name, file_path
- file_size, mime_type

### 依赖服务

- **Email Service**: 新消息/回复通知
- **WebSocket** (可选): 实时未读更新

### 依赖 Skill

- `dev-testing_standards` - 测试驱动开发
- `dev-frontend_patterns` - 前端规范
- `dev-backend_patterns` - 后端规范

---

_Generated by dev-prd skill_
